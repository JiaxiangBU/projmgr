---
title: "Building Custom Plans"
author: "Emily Riederer"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Building Custom Plans}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  eval = FALSE,
  comment = "#>"
)

library(yaml)
library(dplyr)
library(purrr)
library(tibble)
library(tidyr)
```

For larger projects, GitHub milestones provide a convenient way to organize tasks (issues) into broader overarching goals. Sometimes, for projects you do frequently or have a clear plan for analysis, you may wish to *proactively* create issues and organize them into milestones at the beginning of your project instead of *reactively* collecting issues as you work through your project. `tidytracker` helps facilitate this with the notion of a project plan. 

## Project Plans

## Creating a Project Plan in R

## Creating a Project Plan with YAML

```{r}
plan_yaml <- "
milestone1:
  title: Data cleaning and validation
  description: >
    We will conduct data quality checks,
    resolve issues with data quality, and
    document this process
  due_on: 2018-12-31Z12:59:59Z
  issue:
    - title: Define data quality standards
      body: List out decision rules to check data quality
      assignees: [emilyriederer]
      labels: [a, b, c]
    - title: Assess data quality
      body: Use assertthat to test decision rules on dataset
      labels: [low]
    - title: Resolve data quality issues
      body: Conduct needed research to resolve any issues

milestone2:
  title: Exploratory data analysis
  description: >
    Create basic statistics and views to better
    understand dataset and relationships
  issue:
    - title: Summary statistics
      body: Calculate summary statistics 
    - title: Visualizations
      body: Create univariate and bivariate plots
"

parsed <- 
  yaml::yaml.load(plan_yaml, 
                  handlers = list(expr = function(x) eval(parse(text = x))))
df <- map_df(parsed, as.tibble)
```

```{r}

```

```{r}
# create milestones
req <-
  df %>%
  select(-issue) %>%
  distinct() %>%
  pmap(., ~post_milestone(ref, ...))

# add milestone ids
df_issues <-
  df %>%
  nest(issue, .key = "issue") %>%
  mutate(milestone = unlist(map_dbl(req, "number"))) %>%
  select(milestone, issue) %>%
  unnest() 

# create issues
df %>%
    nest(issue, .key = "issue") %>%
    mutate(milestone = unlist(map_dbl(req, "number"))) %>%
    select(milestone, issue) %>%
    unnest() %>%
    transmute(issue = map2(milestone, issue, ~c(milestone = .x, .y))) %>%
    pull(issue) %>%
    map(~modify_at(., c("assignees", "labels"), ~if(length(.) == 1){c(.,.)}else{.})) %>%
    map(~modify_at(., c("assignees", "labels"), list)) %>%
    map(., ~pmap(., ~post_issue(ref, ...)))
  
```



```{r}
issues <- map_df(df$issue, as.tibble)
issues <- issues %>% group_by(title, body) %>% nest()
df_final <- bind_cols( select(df, -issue), issues)
```

```{r}
map_chr(parsed, "title")
map_chr(parsed, "description")
map_chr(1:length(parsed), ~parsed[[.]]$issue)
map_chr(1:length(parsed), ~parsed[[.]]$body)
map_chr(1:length(parsed), ~parsed[[.]]$assignee)
```

```{r}
# works
pmap_df(parsed[[1]]$issue[[1]], ~post_issue(ref, ...))
map_df(parsed[[1]]$issue, 
    .f = ~pmap_df(.x, ~post_issue(ref, ... ))
        )

# works
df$issue[[1]] %>% modify_if(~length(.)>1, list) %>% as.tibble()
df %>% mutate(issue = map(issue, ~modify_if(., ~length(.)>1, list)))

parsed[[1]]$issue[[1]] %>% modify_if(~length(.)>1, list)
parsed[[1]]$issue %>% map(~modify_if(., ~length(.)>1, list))
parsed %>% map("issue") %>% map(~modify_if(., ~length(.)>1, list))
# doesn't: parsed %>% map("issue") %>% map(~modify_at(., c("assignees", "labels"), list))

pmap_df(list_modify(parsed[[1]], "issue" = NULL), ~post_milestone(ref, .))

parsed %>% 
    map(~list_modify(., "issue" = NULL)) %>%
    map(~pmap_df(., ~post_milestone(ref, .)))
```


## Creating a To-Do List

```{r}
todo_yaml <- "
issue1:
  title: Consider renaming my_very_long_function_name
  body: >
    This name is unneccesarily long and hence
    it is very hard and annoying to type
  assignees: [srz549, oec527]
  labels: [design]

issue2:
  title: Make sure documentation links right pages of API docs
"

todo_parsed <- 
  yaml::yaml.load(todo_yaml, 
                  handlers = list(expr = function(x) eval(parse(text = x))))
todo_df <- map_df(todo_parsed, as.tibble)
```

```{r}
# works
res <-
todo_df %>%
    group_by(title) %>%
    mutate_at(vars(one_of("assignees", "labels")), list) %>%
    distinct(title, .keep_all = TRUE) %>%
    mutate_at(vars(one_of("assignees", "labels")), 
              ~map(., ~if(length(.x) == 1){c(.x,.x)}else{.x})) %>%
    pmap(~post_issue(ref, ...))

# works
# todo_parsed[[1]] %>% modify_at(c("assignees", "labels"), list)
# todo_parsed %>% map(., ~modify_at(., c("assignees", "labels"), list) )
```


