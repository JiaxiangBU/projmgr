---
title: "Basic Usage"
author: "Emily Riederer"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

This vignette illustrates basic `ghtrackr` codeflows.

```{r}
library(ghtrackr)
```


## Creating a Repo Reference

The first step to interacting with a GitHub repository is creating a repository reference. Repository references are "first class citizens" in `ghtrackr` and contain all authorization credentials. These references are passed as the first argument in all `get_` functions.

```{r}
dplyr <- create_repo_ref('tidyverse', 'dplyr')
```

Note that this function has many additional parameters that you can specify as needed. For example:

- if you are using GitHub Enterprise, set `is_enterprise = TRUE` and pass your company's internal GitHub URL in through `hostname`
- if you personal access tokens are stored in environment variables with a different name than GITHUB_PAT (or GITHUB_PAT_ENT when `is_enterprise = TRUE`), the name you used can be passed through `hostname`

The `check_` family of functions provide some basic validations that everything is working.

`check_internet()` tests for problems connecting to the internet.

```{r}
check_internet()
```


`check_credentials()` confirms the login associated with the PAT and describes the level of access that PAT have to the specified repo.

```{r}
check_credentials(dplyr)
```

`check_rate_limit()` checks how many more API requests you can send and when that count will reset. Note that this accepts a repo reference as a parameter *only to get authentication information for an account*. Limits to requests are established at the account-level not the repository level.

```{r}
check_rate_limit(dplyr)
```


## Getting Issues

`get_` functions retrieve information from the GitHub API. The first argument is the repository reference and additional named query parameters can be passed subsequently. For example, here, we request issues of the first `milestone` with either an open or closed `state`. (Note that, in keeping with the GitHub API, only open issues are returned when `state` is not specified.)

```{r}
dplyr_issues_list <- get_issues(dplyr, milestone = 1, state = 'all')
```

If you don't know what parameters are available, the `help_<function_name>` family provides more information on valid arguments to include in `get_` and `post_` functions.

```{r}
help_get_issues()
```

More detailed documentation can also be viewed using the `browse_docs()` function, which launches your browser to the appropriate part of the GitHub API documentation. For example, one might run:

```{r}
browse_docs(action = 'get', object = 'issue')
```

Results are returned as a list, closely mirror the JSON output from the actual API.

```{r}
str(dplyr_issues_list[[1]], max.level = 1)
```

It's likely you may prefer to work with them as dataframes instead. The `parse_` family of functions converts "raw" list output from `get_` into tibbles.

```{r}
dplyr_issues <- parse_issues(dplyr_issues_list)
head(dplyr_issues)
```

## Visualizing Issues

There are many different ways to visualize issues. 

For reporting on time-to-completion, `viz_gantt()` creates one horizontal bar per issue and colors issues by length of time open.

```{r}
viz_gantt(dplyr_issues)
```

`viz_taskboard()` creates an Agile-like taskboard of issues open, in progress, and completed.

```{r}
dplyr_issues$closed_at[1] <- NA
dplyr_issues$closed_at[3] <- NA
dplyr_issues$state[c(1,3)] <- "open"
dplyr_issues$labels_name[[3]] <- c("in-progress", dplyr_issues$labels_name[[3]])
viz_taskboard(dplyr_issues, 40)
```

Either task boards or gantt plots can also be passed through `viz_linked` to add links to their text back to the relevant GitHub issues. This only works in RMarkdown with the `results = "asis"` option or saved to a file.

```{r results = 'asis'}
g <- viz_gantt(dplyr_issues)
viz_linked(g)
```


`viz_waterfall_state()` creates a waterfall plot showing, for a fixed time-period, the initial count of open issues, the number of newly reported issues, the number of closed issues, and the final open count as the end of that time period. 

```{r}
viz_waterfall_state(dplyr_issues, '2014-01-01', '2015-01-01')
```

## Reporting On Issue Status

The `report_` function family offers an alternative to visualizations. These functions generate HTML for aethetic output in RMarkdown reports. Output is automatically tagged so `knitr` knows to interpret it as HTML, so it is not necessary to manually add the `results = 'asis'` chunk option. (Don't worry if you don't know what this means. You don't need to do anything!) 

```{r}
report_progress(dplyr_issues)
```

## Posting Issues

The `post_` function family helps add new objects to a GitHub repo. For example, the following command adds a new issue to a repository. After posting new content, `post_` functions return the identification number for the new object.

```{r eval = FALSE}
experigit <- create_repo_ref('emilyriederer', 'experigit')
post_issue(experigit,
           title = "Add unit tests for post_issues when title duplicated",
           body = "Check that code appropriately warns users when attempting to post a duplicate issue",
           labels = c("enhancement", "test"),
           assignees = "emilyriederer" )
```
```{r}
#> [1] 150
```

Natively, the GitHub API allows multiple issues to have the same title. However, you may want to disable this functionality (for example, if a `post_` function is in a script that may be re-run.) In this case, the `distinct` parameter allows you to chose whether or not to allow the posting of new issues with the same title as *open* existing issues. When `distinct = TRUE` (as it is by default), the function throws an error and does not post the issue.

```{r eval = FALSE}
post_issue(experigit, title = "Add unit tests for post_issues when title duplicated")
```
```{r}
#> Error: New issue title is not distinct with current open issues. Please change title or set distinct = FALSE.
```

